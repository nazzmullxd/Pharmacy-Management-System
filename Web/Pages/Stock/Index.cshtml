@page
@model Web.Pages.Stock.IndexModel
@{
    ViewData["Title"] = "Stock Management";
}

<!-- Page Header -->
<div class="page-header">
    <h1><i class="fas fa-boxes"></i> Stock Management</h1>
    <p>Monitor and manage your pharmacy's inventory levels, batches, and stock adjustments.</p>
</div>

<!-- Stock Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="kpi-card">
            <div class="kpi-header">
                <div class="kpi-title">Total Products</div>
                <div class="kpi-icon" style="background: #3498db;">
                    <i class="fas fa-pills"></i>
                </div>
            </div>
            <div class="kpi-value">@Model.TotalProducts</div>
            <div class="kpi-change positive">
                <i class="fas fa-arrow-up"></i> In inventory
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="kpi-card">
            <div class="kpi-header">
                <div class="kpi-title">Low Stock Items</div>
                <div class="kpi-icon" style="background: #f39c12;">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
            </div>
            <div class="kpi-value">@Model.LowStockItems</div>
            <div class="kpi-change negative">
                <i class="fas fa-arrow-down"></i> Need reorder
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="kpi-card">
            <div class="kpi-header">
                <div class="kpi-title">Expiring Soon</div>
                <div class="kpi-icon" style="background: #e74c3c;">
                    <i class="fas fa-clock"></i>
                </div>
            </div>
            <div class="kpi-value">@Model.ExpiringItems</div>
            <div class="kpi-change negative">
                <i class="fas fa-exclamation-triangle"></i> Next 30 days
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="kpi-card">
            <div class="kpi-header">
                <div class="kpi-title">Total Stock Value</div>
                <div class="kpi-icon" style="background: #27ae60;">
                    <i class="fas fa-dollar-sign"></i>
                </div>
            </div>
            <div class="kpi-value">$@Model.TotalStockValue.ToString("N0")</div>
            <div class="kpi-change positive">
                <i class="fas fa-arrow-up"></i> Current value
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="row mb-4">
    <div class="col-md-6">
        <a href="/Stock/Adjustments" class="btn btn-primary">
            <i class="fas fa-edit"></i> Stock Adjustment
        </a>
        <a href="/Stock/Batches" class="btn btn-outline-info">
            <i class="fas fa-layer-group"></i> View Batches
        </a>
        <a href="/Stock/Expiring" class="btn btn-outline-warning">
            <i class="fas fa-clock"></i> Expiring Items
        </a>
    </div>
    <div class="col-md-6">
        <div class="input-group">
            <input type="text" class="form-control search-input" placeholder="Search products...">
            <button class="btn btn-outline-secondary" type="button">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
</div>

<!-- Stock Items Table -->
<div class="table-container">
    <h5><i class="fas fa-list"></i> Current Stock Levels</h5>
    <div class="table-responsive">
        <table class="table table-hover" id="stockTable">
            <thead>
                <tr>
                    <th data-sort="0">Product</th>
                    <th data-sort="1">Category</th>
                    <th data-sort="2">Current Stock</th>
                    <th data-sort="3">Low Stock Threshold</th>
                    <th data-sort="4">Unit Price</th>
                    <th data-sort="5">Total Value</th>
                    <th data-sort="6">Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.StockItems != null && Model.StockItems.Any())
                {
                    @foreach (var item in Model.StockItems)
                    {
                        <tr>
                            <td>
                                <strong>@item.ProductName</strong>
                                @if (!string.IsNullOrEmpty(item.GenericName))
                                {
                                    <br><small class="text-muted">@item.GenericName</small>
                                }
                            </td>
                            <td><span class="badge badge-info">@item.Category</span></td>
                            <td>
                                @if (item.IsLowStock)
                                {
                                    <span class="badge badge-warning">@item.TotalStock</span>
                                }
                                else if (item.TotalStock == 0)
                                {
                                    <span class="badge badge-danger">Out of Stock</span>
                                }
                                else
                                {
                                    <span class="badge badge-success">@item.TotalStock</span>
                                }
                            </td>
                            <td>@item.LowStockThreshold</td>
                            <td>$@item.UnitPrice.ToString("F2")</td>
                            <td>
                                <strong>$@((item.TotalStock * item.UnitPrice).ToString("F2"))</strong>
                            </td>
                            <td>
                                @if (item.TotalStock == 0)
                                {
                                    <span class="badge badge-danger">Out of Stock</span>
                                }
                                else if (item.IsLowStock)
                                {
                                    <span class="badge badge-warning">Low Stock</span>
                                }
                                else
                                {
                                    <span class="badge badge-success">In Stock</span>
                                }
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a href="/Stock/Details/@item.ProductID" class="btn btn-sm btn-outline-info" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="/Stock/Adjustments?productId=@item.ProductID" class="btn btn-sm btn-outline-primary" title="Adjust Stock">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="/Stock/Batches?productId=@item.ProductID" class="btn btn-sm btn-outline-secondary" title="View Batches">
                                        <i class="fas fa-layer-group"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="fas fa-box-open fa-3x mb-3"></i>
                            <br>No stock items found. <a href="/Products/Create">Add products first</a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="table-container">
            <h5><i class="fas fa-exclamation-triangle"></i> Low Stock Alerts</h5>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Current Stock</th>
                            <th>Threshold</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.LowStockAlerts != null && Model.LowStockAlerts.Any())
                        {
                            @foreach (var alert in Model.LowStockAlerts.Take(5))
                            {
                                <tr>
                                    <td>@alert.ProductName</td>
                                    <td><span class="badge badge-warning">@alert.TotalStock</span></td>
                                    <td>@alert.LowStockThreshold</td>
                                    <td>
                                        <a href="/Purchases/New?productId=@alert.ProductID" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-plus"></i> Reorder
                                        </a>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="4" class="text-center text-muted">
                                    <i class="fas fa-check-circle text-success"></i> No low stock alerts
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="table-container">
            <h5><i class="fas fa-clock"></i> Expiring Soon (Next 30 Days)</h5>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Batch</th>
                            <th>Expiry Date</th>
                            <th>Days Left</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.ExpiringAlerts != null && Model.ExpiringAlerts.Any())
                        {
                            @foreach (var alert in Model.ExpiringAlerts.Take(5))
                            {
                                <tr>
                                    <td>@alert.ProductName</td>
                                    <td>@alert.BatchNumber</td>
                                    <td>@alert.ExpiryDate.ToString("MMM dd, yyyy")</td>
                                    <td>
                                        @if (alert.DaysUntilExpiry <= 7)
                                        {
                                            <span class="badge badge-danger">@alert.DaysUntilExpiry days</span>
                                        }
                                        else if (alert.DaysUntilExpiry <= 15)
                                        {
                                            <span class="badge badge-warning">@alert.DaysUntilExpiry days</span>
                                        }
                                        else
                                        {
                                            <span class="badge badge-info">@alert.DaysUntilExpiry days</span>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="4" class="text-center text-muted">
                                    <i class="fas fa-check-circle text-success"></i> No expiring items
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Auto-refresh stock data every 5 minutes
        setInterval(function() {
            // In a real implementation, this would make an API call to refresh data
            console.log('Refreshing stock data...');
        }, 300000); // 5 minutes
    </script>
}
