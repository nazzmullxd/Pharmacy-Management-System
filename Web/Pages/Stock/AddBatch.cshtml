@page
@model Web.Pages.Stock.AddBatchModel
@{
    ViewData["Title"] = "Add Stock Batch";
}

<!-- Page Header -->
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1><i class="fas fa-plus-circle text-success"></i> Add New Stock Batch</h1>
            <p class="mb-0">Create a new batch entry to track product inventory, expiry dates, and supplier information</p>
        </div>
        <div class="d-flex gap-2">
            <a href="/Stock/Batches" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Batches
            </a>
            <a href="/Stock" class="btn btn-outline-info">
                <i class="fas fa-warehouse"></i> Stock Overview
            </a>
            <button class="btn btn-outline-primary" onclick="clearForm()">
                <i class="fas fa-undo"></i> Clear Form
            </button>
        </div>
    </div>
</div>

<!-- Add Batch Form -->
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="dashboard-card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-layer-group me-2"></i>Batch Information
                </h5>
            </div>
            <div class="card-body">
                <form method="post" id="addBatchForm">
                    <div class="row g-4">
                        <!-- Product Selection -->
                        <div class="col-md-6">
                            <label for="Batch_ProductID" class="form-label">
                                <i class="fas fa-pills text-success me-1"></i>Product *
                            </label>
                            <select asp-for="Batch.ProductID" class="form-select search-select" required>
                                <option value="">Select product for this batch...</option>
                                @foreach (var p in Model.Products)
                                {
                                    <option value="@p.ProductID" data-generic="@p.GenericName" data-category="@p.Category">
                                        @p.ProductName @(!string.IsNullOrEmpty(p.GenericName) ? $"({p.GenericName})" : "")
                                    </option>
                                }
                            </select>
                            <div class="form-text">
                                <i class="fas fa-info-circle text-info me-1"></i>
                                Choose the product you're adding to inventory
                            </div>
                        </div>

                        <!-- Supplier Selection -->
                        <div class="col-md-6">
                            <label for="Batch_SupplierID" class="form-label">
                                <i class="fas fa-truck text-success me-1"></i>Supplier *
                            </label>
                            <select asp-for="Batch.SupplierID" class="form-select search-select" required>
                                <option value="">Select supplier for this batch...</option>
                                @foreach (var s in Model.Suppliers)
                                {
                                    <option value="@s.SupplierID" data-contact="@s.ContactPerson" data-phone="@s.PhoneNumber">
                                        @s.SupplierName
                                    </option>
                                }
                            </select>
                            <div class="form-text">
                                <i class="fas fa-info-circle text-info me-1"></i>
                                Select the supplier providing this batch
                            </div>
                        </div>

                        <!-- Batch Number -->
                        <div class="col-md-6">
                            <label for="Batch_BatchNumber" class="form-label">
                                <i class="fas fa-barcode text-success me-1"></i>Batch Number *
                            </label>
                            <input asp-for="Batch.BatchNumber" class="form-control" required 
                                   placeholder="e.g., BTH-2024-001, LOT123456">
                            <div class="form-text">
                                Enter the manufacturer's batch/lot number
                            </div>
                        </div>

                        <!-- Expiry Date -->
                        <div class="col-md-6">
                            <label for="Batch_ExpiryDate" class="form-label">
                                <i class="fas fa-calendar-alt text-success me-1"></i>Expiry Date *
                            </label>
                            <input asp-for="Batch.ExpiryDate" type="date" class="form-control" required 
                                   min="@DateTime.Now.AddDays(1).ToString("yyyy-MM-dd")"
                                   max="@DateTime.Now.AddYears(10).ToString("yyyy-MM-dd")">
                            <div class="form-text" id="expiryDays">
                                Must be at least tomorrow
                            </div>
                        </div>

                        <!-- Quantity -->
                        <div class="col-md-6">
                            <label for="Batch_QuantityInStock" class="form-label">
                                <i class="fas fa-sort-numeric-up text-success me-1"></i>Initial Quantity *
                            </label>
                            <input asp-for="Batch.QuantityInStock" type="number" min="1" max="999999" 
                                   class="form-control" required placeholder="Enter quantity received">
                            <div class="form-text">
                                Number of units in this batch
                            </div>
                        </div>

                        <!-- Purchase Price (Optional) -->
                        <div class="col-md-6">
                            <label for="PurchasePrice" class="form-label">
                                <i class="fas fa-dollar-sign text-success me-1"></i>Purchase Price (Optional)
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" step="0.01" min="0" class="form-control" 
                                       id="PurchasePrice" name="PurchasePrice" placeholder="0.00">
                            </div>
                            <div class="form-text">
                                Cost per unit for this batch
                            </div>
                        </div>
                    </div>

                    <!-- Product & Supplier Info Display -->
                    <div id="productInfo" style="display: none;" class="mt-4">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>Product Information</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Generic Name:</strong> <span id="productGeneric"></span><br>
                                    <strong>Category:</strong> <span id="productCategory"></span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Supplier Contact:</strong> <span id="supplierContact"></span><br>
                                    <strong>Phone:</strong> <span id="supplierPhone"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Details -->
                    <div class="mt-4">
                        <h6 class="text-muted mb-3">
                            <i class="fas fa-clipboard-list text-success me-1"></i>Additional Information (Optional)
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="PurchaseOrderNumber" class="form-label">Purchase Order #</label>
                                <input type="text" class="form-control" id="PurchaseOrderNumber" 
                                       name="PurchaseOrderNumber" placeholder="PO-2024-001">
                            </div>
                            <div class="col-md-6">
                                <label for="ManufacturingDate" class="form-label">Manufacturing Date</label>
                                <input type="date" class="form-control" id="ManufacturingDate" 
                                       name="ManufacturingDate" max="@DateTime.Now.ToString("yyyy-MM-dd")">
                            </div>
                            <div class="col-md-12">
                                <label for="Notes" class="form-label">Notes</label>
                                <textarea class="form-control" id="Notes" name="Notes" rows="3" 
                                          placeholder="Any additional notes about this batch..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="d-flex gap-2 mt-4 pt-3 border-top">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-save me-2"></i>Save Batch
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="saveAndAddAnother()">
                            <i class="fas fa-plus me-2"></i>Save & Add Another
                        </button>
                        <button type="reset" class="btn btn-outline-secondary">
                            <i class="fas fa-undo me-2"></i>Reset Form
                        </button>
                        <a href="/Stock/Batches" class="btn btn-outline-secondary ms-auto">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                    </div>

                    <div asp-validation-summary="All" class="text-danger mt-3"></div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Quick Tips -->
<div class="row justify-content-center mt-4">
    <div class="col-lg-8">
        <div class="card border-success">
            <div class="card-header bg-light">
                <h6 class="mb-0 text-success">
                    <i class="fas fa-lightbulb me-2"></i>Quick Tips for Adding Batches
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                Double-check batch numbers for accuracy
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                Verify expiry dates against product packaging
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                Ensure quantity matches received goods
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                Keep original packaging for reference
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                Record purchase prices for inventory valuation
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                Add notes for special storage requirements
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const productSelect = document.getElementById('Batch_ProductID');
    const supplierSelect = document.getElementById('Batch_SupplierID');
    const expiryInput = document.getElementById('Batch_ExpiryDate');
    const productInfo = document.getElementById('productInfo');

    productSelect.addEventListener('change', function() {
        updateProductInfo();
    });

    supplierSelect.addEventListener('change', function() {
        updateProductInfo();
    });

    expiryInput.addEventListener('change', function() {
        updateExpiryDays();
    });

    function updateProductInfo() {
        const productOption = productSelect.options[productSelect.selectedIndex];
        const supplierOption = supplierSelect.options[supplierSelect.selectedIndex];

        if (productOption.value || supplierOption.value) {
            if (productOption.value) {
                document.getElementById('productGeneric').textContent = productOption.dataset.generic || 'N/A';
                document.getElementById('productCategory').textContent = productOption.dataset.category || 'N/A';
            }
            
            if (supplierOption.value) {
                document.getElementById('supplierContact').textContent = supplierOption.dataset.contact || 'N/A';
                document.getElementById('supplierPhone').textContent = supplierOption.dataset.phone || 'N/A';
            }
            
            productInfo.style.display = 'block';
        } else {
            productInfo.style.display = 'none';
        }
    }

    function updateExpiryDays() {
        const expiryDate = new Date(expiryInput.value);
        const today = new Date();
        const diffTime = expiryDate.getTime() - today.getTime();
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        const expiryDaysDiv = document.getElementById('expiryDays');
        if (diffDays > 0) {
            expiryDaysDiv.textContent = `Expires in ${diffDays} days`;
            expiryDaysDiv.className = 'form-text text-success';
        } else if (diffDays === 0) {
            expiryDaysDiv.textContent = 'Expires today';
            expiryDaysDiv.className = 'form-text text-warning';
        } else {
            expiryDaysDiv.textContent = 'Date is in the past';
            expiryDaysDiv.className = 'form-text text-danger';
        }
    }
});

function clearForm() {
    document.getElementById('addBatchForm').reset();
    document.getElementById('productInfo').style.display = 'none';
    document.getElementById('expiryDays').textContent = 'Must be at least tomorrow';
    document.getElementById('expiryDays').className = 'form-text';
}

function saveAndAddAnother() {
    // Set a flag to indicate we want to add another after saving
    const form = document.getElementById('addBatchForm');
    const hiddenField = document.createElement('input');
    hiddenField.type = 'hidden';
    hiddenField.name = 'AddAnother';
    hiddenField.value = 'true';
    form.appendChild(hiddenField);
    form.submit();
}
</script>