@page
@model Web.Pages.Reports.SalesModel
@{
    ViewData["Title"] = "Sales Reports";
}

<!-- Page Header -->
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1><i class="fas fa-chart-line text-primary"></i> Sales Reports</h1>
            <p class="mb-0">Comprehensive sales analytics and performance insights for Rabiul Pharmacy</p>
        </div>
        <div class="d-flex gap-2">
            <a href="/" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
            <button class="btn btn-outline-primary" onclick="exportToExcel()">
                <i class="fas fa-download"></i> Export Report
            </button>
            <button class="btn btn-primary" onclick="window.print()">
                <i class="fas fa-print"></i> Print Report
            </button>
        </div>
    </div>
</div>

<!-- Quick Actions & Filters -->
<div class="dashboard-card mb-4">
    <div class="row align-items-center">
        <div class="col-md-4">
            <h6 class="mb-2 text-muted">Report Controls</h6>
            <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-sm btn-success" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="btn btn-sm btn-outline-info" onclick="customDateRange()">
                    <i class="fas fa-calendar-alt"></i> Custom Period
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="generateDetailedReport()">
                    <i class="fas fa-chart-pie"></i> Detailed Analytics
                </button>
            </div>
        </div>
        <div class="col-md-8">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label small text-muted">Report Period</label>
                    <select class="form-select form-select-sm" id="periodFilter">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week" selected>This Week</option>
                        <option value="month">This Month</option>
                        <option value="quarter">This Quarter</option>
                        <option value="year">This Year</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label small text-muted">Sales Channel</label>
                    <select class="form-select form-select-sm" id="channelFilter">
                        <option value="">All Channels</option>
                        <option value="walk-in">Walk-in Sales</option>
                        <option value="registered">Registered Customers</option>
                        <option value="prescription">Prescription Sales</option>
                        <option value="otc">Over-the-Counter</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label small text-muted">Search Reports</label>
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control" id="searchInput" placeholder="Product, Customer...">
                        <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Sales Summary Cards -->
<div class="kpi-grid mb-4">
    <div class="kpi-card">
        <div class="kpi-header">
            <div class="kpi-title">Total Sales Revenue</div>
            <div class="kpi-icon" style="background: linear-gradient(45deg, #27ae60, #2ecc71);">
                <i class="fas fa-dollar-sign"></i>
            </div>
        </div>
        <div class="kpi-value">@Model.TotalSales.ToString("C")</div>
        <div class="kpi-change positive">
            <i class="fas fa-arrow-up"></i> 
            @{
                var avgSale = Model.TotalInvoices > 0 ? Model.TotalSales / Model.TotalInvoices : 0;
            }
            Avg: @avgSale.ToString("C") per sale
        </div>
        <div class="kpi-progress mt-2">
            <div class="progress" style="height: 4px;">
                <div class="progress-bar bg-success" role="progressbar" style="width: 85%" aria-valuenow="85" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
        </div>
    </div>

    <div class="kpi-card">
        <div class="kpi-header">
            <div class="kpi-title">Total Transactions</div>
            <div class="kpi-icon" style="background: linear-gradient(45deg, #3498db, #5dade2);">
                <i class="fas fa-receipt"></i>
            </div>
        </div>
        <div class="kpi-value">@Model.TotalInvoices.ToString("N0")</div>
        <div class="kpi-change positive">
            <i class="fas fa-chart-line"></i> Transaction volume
        </div>
        <div class="kpi-progress mt-2">
            <div class="progress" style="height: 4px;">
                <div class="progress-bar bg-info" role="progressbar" style="width: 70%" aria-valuenow="70" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
        </div>
    </div>

    <div class="kpi-card">
        <div class="kpi-header">
            <div class="kpi-title">Today's Performance</div>
            <div class="kpi-icon" style="background: linear-gradient(45deg, #f39c12, #f7dc6f);">
                <i class="fas fa-calendar-day"></i>
            </div>
        </div>
        <div class="kpi-value">@Model.TodaySales.ToString("C")</div>
        <div class="kpi-change @(Model.TodaySales > (Model.MonthlySales / 30) ? "positive" : "")">
            <i class="fas @(Model.TodaySales > (Model.MonthlySales / 30) ? "fa-trending-up" : "fa-equals")"></i> 
            @(Model.TodaySales > (Model.MonthlySales / 30) ? "Above average" : "On track")
        </div>
        <div class="kpi-progress mt-2">
            <div class="progress" style="height: 4px;">
                <div class="progress-bar bg-warning" role="progressbar" style="width: 65%" aria-valuenow="65" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
        </div>
    </div>

    <div class="kpi-card">
        <div class="kpi-header">
            <div class="kpi-title">Monthly Target</div>
            <div class="kpi-icon" style="background: linear-gradient(45deg, #9b59b6, #bb8fce);">
                <i class="fas fa-bullseye"></i>
            </div>
        </div>
        <div class="kpi-value">@Model.MonthlySales.ToString("C")</div>
        <div class="kpi-change">
            <i class="fas fa-calendar-month"></i> This month's performance
        </div>
        <div class="kpi-progress mt-2">
            <div class="progress" style="height: 4px;">
                <div class="progress-bar bg-purple" role="progressbar" style="width: 80%" aria-valuenow="80" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
        </div>
    </div>
</div>

<!-- Charts and Analytics Section -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="dashboard-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="fas fa-chart-area text-primary"></i> Sales Trend Analysis</h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary active" onclick="changeChartPeriod('week')">Week</button>
                    <button type="button" class="btn btn-outline-primary" onclick="changeChartPeriod('month')">Month</button>
                    <button type="button" class="btn btn-outline-primary" onclick="changeChartPeriod('quarter')">Quarter</button>
                </div>
            </div>
            <div class="chart-container" style="height: 300px; display: flex; align-items: center; justify-content: center; background: linear-gradient(45deg, #f8f9fa, #e9ecef); border-radius: 8px;">
                <div class="text-center">
                    <i class="fas fa-chart-area fa-3x text-muted mb-3"></i>
                    <h6 class="text-muted">Sales Trend Chart</h6>
                    <p class="text-muted mb-0">Chart visualization will be implemented here</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="dashboard-card h-100">
            <h5 class="mb-3"><i class="fas fa-chart-pie text-primary"></i> Sales Distribution</h5>
            <div class="sales-distribution">
                <div class="distribution-item mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="small">Walk-in Sales</span>
                        <span class="small fw-bold">45%</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-primary" style="width: 45%"></div>
                    </div>
                </div>
                <div class="distribution-item mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="small">Registered Customers</span>
                        <span class="small fw-bold">35%</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-success" style="width: 35%"></div>
                    </div>
                </div>
                <div class="distribution-item mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="small">Prescription Sales</span>
                        <span class="small fw-bold">20%</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-warning" style="width: 20%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Analytics Tables -->
<div class="row">
    <div class="col-md-6">
        <div class="table-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="fas fa-trophy text-warning"></i> Top Selling Products</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="viewAllProducts()">
                    <i class="fas fa-external-link-alt"></i> View All
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Rank</th>
                            <th>Product Name</th>
                            <th class="text-center">Qty Sold</th>
                            <th class="text-end">Revenue</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{int rank = 1;}
                        @foreach (var p in Model.TopProducts.Take(10))
                        {
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        @if (rank <= 3)
                                        {
                                            <span class="badge bg-@(rank == 1 ? "warning" : rank == 2 ? "secondary" : "warning") me-2">
                                                @(rank == 1 ? "🥇" : rank == 2 ? "🥈" : "🥉")
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-light text-dark me-2">#@rank</span>
                                        }
                                    </div>
                                </td>
                                <td>
                                    <div class="product-info">
                                        <div class="product-name">@p.ProductName</div>
                                        <small class="text-muted">
                                            <i class="fas fa-pills me-1"></i>High demand
                                        </small>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-info">@p.TotalQuantitySold</span>
                                </td>
                                <td class="text-end">
                                    <strong class="text-success">@p.TotalRevenue.ToString("C")</strong>
                                </td>
                            </tr>
                            rank++;
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="table-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="fas fa-clock text-info"></i> Recent Sales Activity</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="viewAllSales()">
                    <i class="fas fa-external-link-alt"></i> View All
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Date & Time</th>
                            <th>Customer</th>
                            <th class="text-end">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var s in Model.Sales.OrderByDescending(x => x.SaleDate).Take(10))
                        {
                            <tr>
                                <td>
                                    <div class="date-info">
                                        <div class="sale-date">@s.SaleDate.ToString("MMM dd")</div>
                                        <small class="sale-time text-muted">
                                            <i class="fas fa-clock me-1"></i>@s.SaleDate.ToString("hh:mm tt")
                                        </small>
                                    </div>
                                </td>
                                <td>
                                    <div class="customer-info">
                                        <div class="customer-name">@s.CustomerName</div>
                                        <small class="text-muted">
                                            @if (s.CustomerName != "Walk-in Customer")
                                            {
                                                <text><i class="fas fa-user me-1"></i>Registered</text>
                                            }
                                            else
                                            {
                                                <text><i class="fas fa-walking me-1"></i>Walk-in</text>
                                            }
                                        </small>
                                    </div>
                                </td>
                                <td class="text-end">
                                    <strong class="text-success">@s.TotalAmount.ToString("C")</strong>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Performance Insights -->
<div class="dashboard-card mt-4">
    <h5 class="mb-3"><i class="fas fa-lightbulb text-warning"></i> Performance Insights</h5>
    <div class="row">
        <div class="col-md-4">
            <div class="insight-card bg-light p-3 rounded">
                <h6 class="text-success"><i class="fas fa-arrow-up me-2"></i>Growth Opportunity</h6>
                <p class="mb-2 small">Your top products are driving 60% of revenue. Consider expanding inventory for high-demand items.</p>
                <button class="btn btn-sm btn-outline-success">View Recommendations</button>
            </div>
        </div>
        <div class="col-md-4">
            <div class="insight-card bg-light p-3 rounded">
                <h6 class="text-info"><i class="fas fa-users me-2"></i>Customer Pattern</h6>
                <p class="mb-2 small">Walk-in customers represent 45% of sales. Consider a loyalty program to encourage registration.</p>
                <button class="btn btn-sm btn-outline-info">Customer Analytics</button>
            </div>
        </div>
        <div class="col-md-4">
            <div class="insight-card bg-light p-3 rounded">
                <h6 class="text-warning"><i class="fas fa-clock me-2"></i>Peak Hours</h6>
                <p class="mb-2 small">Most sales occur between 2-6 PM. Optimize staffing during these peak hours.</p>
                <button class="btn btn-sm btn-outline-warning">Schedule Analysis</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Initialize page functionality
        document.addEventListener('DOMContentLoaded', function() {
            initializeFilters();
            initializeCharts();
        });

        function initializeFilters() {
            document.getElementById('periodFilter').addEventListener('change', filterReports);
            document.getElementById('channelFilter').addEventListener('change', filterReports);
            document.getElementById('searchInput').addEventListener('input', debounce(filterReports, 300));
            document.getElementById('searchBtn').addEventListener('click', filterReports);
        }

        function filterReports() {
            // Implementation for filtering reports
            console.log('Filtering reports...');
        }

        function changeChartPeriod(period) {
            // Remove active class from all buttons
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            console.log(`Changing chart period to: ${period}`);
            // Chart update logic would go here
        }

        function initializeCharts() {
            // Chart initialization logic would go here
            console.log('Charts initialized');
        }

        // Action functions
        function refreshData() {
            window.location.reload();
        }

        function customDateRange() {
            alert('Custom date range selector coming soon');
        }

        function generateDetailedReport() {
            alert('Detailed analytics report generation coming soon');
        }

        function exportToExcel() {
            alert('Excel export functionality coming soon');
        }

        function viewAllProducts() {
            window.location.href = '/Products';
        }

        function viewAllSales() {
            window.location.href = '/Sales';
        }

        // Debounce function for search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
}

