@model MVC_WEB.Models.ViewModels.UserListViewModel
@{
    ViewData["Title"] = "User Management";
}

<!-- Page Header -->
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div>
            <h1><i class="fas fa-user-cog text-primary"></i> User Management</h1>
            <p class="mb-0">Manage system users, roles, and access permissions for your pharmacy</p>
        </div>
        <div class="d-flex gap-2 flex-wrap">
            <a asp-action="Create" class="btn btn-primary">
                <i class="fas fa-user-plus"></i> Add New User
            </a>
            <button type="button" class="btn btn-outline-secondary" onclick="exportUsers()">
                <i class="fas fa-download"></i> Export
            </button>
        </div>
    </div>
</div>

<!-- Quick Filters & Search -->
<div class="dashboard-card mb-4">
    <div class="row align-items-center">
        <div class="col-md-4">
            <h6 class="mb-2 text-muted">Quick Actions</h6>
            <div class="d-flex gap-2 flex-wrap">
                <a asp-action="Create" class="btn btn-sm btn-success">
                    <i class="fas fa-user-plus"></i> Add User
                </a>
                <button class="btn btn-sm btn-outline-secondary" onclick="window.location.reload()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
        <div class="col-md-8">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label small text-muted">Filter by Role</label>
                    <select class="form-select form-select-sm" id="roleFilter">
                        <option value="">All Roles</option>
                        <option value="Admin">Admin</option>
                        <option value="User">User</option>
                        <option value="Manager">Manager</option>
                        <option value="Pharmacist">Pharmacist</option>
                        <option value="Staff">Staff</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label small text-muted">Status</label>
                    <select class="form-select form-select-sm" id="statusFilter">
                        <option value="">All Users</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label small text-muted">Search Users</label>
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control" id="searchInput" placeholder="Name, email...">
                        <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Statistics Cards -->
<div class="kpi-grid mb-4">
    <div class="kpi-card">
        <div class="kpi-header">
            <div class="kpi-title">Total Users</div>
            <div class="kpi-icon" style="background: linear-gradient(45deg, #3498db, #5dade2);">
                <i class="fas fa-users"></i>
            </div>
        </div>
        <div class="kpi-value">@Model.TotalUsers</div>
        <div class="kpi-change positive">
            <i class="fas fa-chart-bar"></i> System users
        </div>
    </div>

    <div class="kpi-card">
        <div class="kpi-header">
            <div class="kpi-title">Active Users</div>
            <div class="kpi-icon" style="background: linear-gradient(45deg, #27ae60, #2ecc71);">
                <i class="fas fa-user-check"></i>
            </div>
        </div>
        <div class="kpi-value">@Model.ActiveUsers</div>
        <div class="kpi-change positive">
            <i class="fas fa-arrow-up"></i> Currently active
        </div>
    </div>

    <div class="kpi-card">
        <div class="kpi-header">
            <div class="kpi-title">Admin Users</div>
            <div class="kpi-icon" style="background: linear-gradient(45deg, #e74c3c, #ec7063);">
                <i class="fas fa-user-shield"></i>
            </div>
        </div>
        <div class="kpi-value">@Model.AdminCount</div>
        <div class="kpi-change neutral">
            <i class="fas fa-shield-alt"></i> Administrators
        </div>
    </div>

    <div class="kpi-card">
        <div class="kpi-header">
            <div class="kpi-title">Staff Members</div>
            <div class="kpi-icon" style="background: linear-gradient(45deg, #9b59b6, #bb6bd9);">
                <i class="fas fa-user-tie"></i>
            </div>
        </div>
        <div class="kpi-value">@Model.StaffCount</div>
        <div class="kpi-change positive">
            <i class="fas fa-users"></i> Team members
        </div>
    </div>
</div>

<!-- Users Table -->
<div class="table-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0"><i class="fas fa-list text-primary"></i> All Users</h5>
        <div class="d-flex align-items-center gap-3">
            <small class="text-muted" id="resultsCount">
                Showing @Model.TotalUsers users
            </small>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-primary" onclick="toggleView('table')" id="tableViewBtn">
                    <i class="fas fa-table"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="toggleView('card')" id="cardViewBtn">
                    <i class="fas fa-th-large"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Table View -->
    <div id="tableView" class="table-responsive">
        <table class="table table-hover" id="usersTable">
            <thead class="table-light">
                <tr>
                    <th class="sortable" data-sort="0">
                        <i class="fas fa-user text-muted me-1"></i>Full Name
                        <i class="fas fa-sort text-muted ms-1"></i>
                    </th>
                    <th class="sortable" data-sort="1">
                        <i class="fas fa-envelope text-muted me-1"></i>Email Address
                        <i class="fas fa-sort text-muted ms-1"></i>
                    </th>
                    <th class="sortable" data-sort="2">
                        <i class="fas fa-shield-alt text-muted me-1"></i>Role
                        <i class="fas fa-sort text-muted ms-1"></i>
                    </th>
                    <th class="text-center">
                        <i class="fas fa-clock text-muted me-1"></i>Last Login
                    </th>
                    <th class="text-center">
                        <i class="fas fa-toggle-on text-muted me-1"></i>Status
                    </th>
                    <th class="text-center" style="width: 150px;">
                        <i class="fas fa-cogs text-muted me-1"></i>Actions
                    </th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Users != null && Model.Users.Any())
                {
                    @foreach (var user in Model.Users)
                    {
                        <tr class="user-row" data-user-id="@user.UserID">
                            <td data-label="Full Name">
                                <div class="user-info d-flex align-items-center">
                                    <div class="user-avatar me-3">
                                        <div class="avatar-circle">
                                            @(user.FullName?.Split(' ').Select(n => n.FirstOrDefault()).Take(2).Aggregate("", (acc, c) => acc + c))
                                        </div>
                                    </div>
                                    <div>
                                        <div class="user-name fw-semibold">@user.FullName</div>
                                        <small class="user-id text-muted">
                                            <i class="fas fa-tag me-1"></i>ID: @user.UserID.ToString().Substring(0, 8)...
                                        </small>
                                    </div>
                                </div>
                            </td>
                            <td data-label="Email">
                                <div class="email-info">
                                    <a href="mailto:@user.Email" class="text-decoration-none">
                                        <i class="fas fa-envelope me-1 text-info"></i>@user.Email
                                    </a>
                                </div>
                            </td>
                            <td data-label="Role">
                                @{
                                    var roleColor = user.Role switch
                                    {
                                        "Admin" => "danger",
                                        "Manager" => "warning",
                                        "Pharmacist" => "success",
                                        "Staff" => "info",
                                        "User" => "primary",
                                        _ => "secondary"
                                    };
                                    var roleIcon = user.Role switch
                                    {
                                        "Admin" => "fa-user-shield",
                                        "Manager" => "fa-user-tie",
                                        "Pharmacist" => "fa-user-md",
                                        "Staff" => "fa-user",
                                        "User" => "fa-user",
                                        _ => "fa-user"
                                    };
                                }
                                <span class="badge bg-@roleColor role-badge">
                                    <i class="fas @roleIcon me-1"></i>@user.Role
                                </span>
                            </td>
                            <td class="text-center" data-label="Last Login">
                                <small class="text-muted">
                                    @if (user.LastLoginDate != default)
                                    {
                                        @user.LastLoginDate.ToString("MMM dd, yyyy")
                                    }
                                    else
                                    {
                                        <span>Never</span>
                                    }
                                </small>
                            </td>
                            <td class="text-center" data-label="Status">
                                <span class="badge bg-success status-badge">
                                    <i class="fas fa-check-circle me-1"></i>Active
                                </span>
                            </td>
                            <td data-label="Actions">
                                <div class="action-buttons d-flex gap-1 justify-content-center">
                                    <a asp-action="Details" asp-route-id="@user.UserID" 
                                       class="btn btn-sm btn-outline-info" 
                                       title="View Details"
                                       data-bs-toggle="tooltip">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a asp-action="Edit" asp-route-id="@user.UserID" 
                                       class="btn btn-sm btn-outline-primary" 
                                       title="Edit User"
                                       data-bs-toggle="tooltip">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                                type="button" 
                                                data-bs-toggle="dropdown" 
                                                aria-expanded="false"
                                                title="More Actions">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li>
                                                <a class="dropdown-item" asp-action="Details" asp-route-id="@user.UserID">
                                                    <i class="fas fa-eye me-2"></i>View Profile
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" asp-action="Edit" asp-route-id="@user.UserID">
                                                    <i class="fas fa-edit me-2"></i>Edit User
                                                </a>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <button class="dropdown-item" onclick="resetPassword('@user.UserID', '@user.FullName')">
                                                    <i class="fas fa-key me-2"></i>Reset Password
                                                </button>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <a class="dropdown-item text-danger" asp-action="Delete" asp-route-id="@user.UserID">
                                                    <i class="fas fa-trash me-2"></i>Delete User
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr id="emptyRow">
                        <td colspan="6" class="text-center py-5">
                            <div class="empty-state">
                                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                <h6 class="text-muted">No users found</h6>
                                <p class="text-muted mb-3">Start by adding your first system user</p>
                                <a asp-action="Create" class="btn btn-primary">
                                    <i class="fas fa-user-plus"></i> Add First User
                                </a>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Card View (Alternative) -->
    <div id="cardView" style="display: none;" class="row">
        @if (Model.Users != null && Model.Users.Any())
        {
            @foreach (var user in Model.Users)
            {
                <div class="col-lg-6 col-xl-4 mb-3 user-card-wrapper" data-user-id="@user.UserID">
                    <div class="card user-card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="user-avatar me-2">
                                    <div class="avatar-circle small">
                                        @(user.FullName?.Split(' ').Select(n => n.FirstOrDefault()).Take(2).Aggregate("", (acc, c) => acc + c))
                                    </div>
                                </div>
                                <h6 class="mb-0 user-name-card">@user.FullName</h6>
                            </div>
                            @{
                                var cardRoleColor = user.Role switch
                                {
                                    "Admin" => "danger",
                                    "Manager" => "warning",
                                    "Pharmacist" => "success",
                                    "Staff" => "info",
                                    "User" => "primary",
                                    _ => "secondary"
                                };
                            }
                            <span class="badge bg-@cardRoleColor role-badge-card">@user.Role</span>
                        </div>
                        <div class="card-body">
                            <div class="contact-details">
                                <p class="mb-2 email-card">
                                    <i class="fas fa-envelope me-2 text-info"></i>
                                    <a href="mailto:@user.Email" class="text-decoration-none small">@user.Email</a>
                                </p>
                                <p class="mb-2">
                                    <i class="fas fa-clock me-2 text-muted"></i>
                                    <small class="text-muted">
                                        Last login: @(user.LastLoginDate != default ? user.LastLoginDate.ToString("MMM dd") : "Never")
                                    </small>
                                </p>
                                <p class="mb-0">
                                    <i class="fas fa-check-circle me-2 text-success"></i>
                                    <small class="text-success">Active Status</small>
                                </p>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="d-flex gap-1">
                                <a asp-action="Details" asp-route-id="@user.UserID" 
                                   class="btn btn-sm btn-outline-info flex-fill">
                                    <i class="fas fa-eye"></i> View
                                </a>
                                <a asp-action="Edit" asp-route-id="@user.UserID" 
                                   class="btn btn-sm btn-outline-primary flex-fill">
                                    <i class="fas fa-edit"></i> Edit
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
    </div>
</div>

@section Styles {
    <style>
        .user-avatar {
            display: inline-block;
        }

        .avatar-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #007bff, #6c757d);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .avatar-circle.small {
            width: 32px;
            height: 32px;
            font-size: 12px;
        }

        .user-info {
            align-items: center;
        }

        .user-name {
            font-weight: 600;
            line-height: 1.2;
        }

        .role-badge, .status-badge {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
        }

        .user-card {
            transition: transform 0.2s ease-in-out;
        }

        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .contact-details p {
            margin-bottom: 0.5rem;
        }

        .sortable {
            cursor: pointer;
            user-select: none;
        }

        .sortable:hover {
            background-color: #f8f9fa;
        }

        .sort-asc .fa-sort:before {
            content: "\f0de"; /* fa-sort-up */
        }

        .sort-desc .fa-sort:before {
            content: "\f0dd"; /* fa-sort-down */
        }

        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }

        .dashboard-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .kpi-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
            transition: transform 0.2s ease-in-out;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .kpi-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: #212529;
            margin-bottom: 0.5rem;
        }

        .kpi-change {
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .kpi-change.positive { color: #28a745; }
        .kpi-change.negative { color: #dc3545; }
        .kpi-change.neutral { color: #6c757d; }

        /* Mobile responsive */
        @@media (max-width: 768px) {
            .page-header .d-flex {
                flex-direction: column;
                gap: 1rem;
            }
            
            .page-header .btn {
                width: 100%;
            }

            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .user-avatar {
                display: none;
            }
        }
    </style>
}

@section Scripts {
    <script>
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Enhanced filtering functionality
        document.getElementById('roleFilter').addEventListener('change', function() {
            filterUsers();
        });

        document.getElementById('statusFilter').addEventListener('change', function() {
            filterUsers();
        });

        // Enhanced Search functionality
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');

        searchInput.addEventListener('input', debounce(filterUsers, 300));
        searchBtn.addEventListener('click', filterUsers);

        function filterUsers() {
            const roleFilter = document.getElementById('roleFilter').value.toLowerCase();
            const searchTerm = searchInput.value.toLowerCase();
            
            // Filter table rows
            const rows = document.querySelectorAll('#usersTable tbody tr.user-row');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const userNameCell = row.querySelector('.user-name');
                const emailCell = row.querySelector('.email-info a');
                const roleCell = row.querySelector('.role-badge');
                
                let shouldShow = true;
                
                // Role filter
                if (roleFilter && roleCell) {
                    const role = roleCell.textContent.toLowerCase().trim();
                    if (!role.includes(roleFilter)) {
                        shouldShow = false;
                    }
                }
                
                // Search filter
                if (searchTerm && shouldShow) {
                    const searchableText = [
                        userNameCell?.textContent || '',
                        emailCell?.textContent || ''
                    ].join(' ').toLowerCase();
                    
                    if (!searchableText.includes(searchTerm)) {
                        shouldShow = false;
                    }
                }
                
                row.style.display = shouldShow ? '' : 'none';
                if (shouldShow) visibleCount++;
            });

            // Filter card view
            const cards = document.querySelectorAll('.user-card-wrapper');
            cards.forEach(card => {
                const userName = card.querySelector('.user-name-card')?.textContent || '';
                const email = card.querySelector('.email-card a')?.textContent || '';
                const role = card.querySelector('.role-badge-card')?.textContent.toLowerCase().trim() || '';
                
                let shouldShow = true;
                
                if (roleFilter && !role.includes(roleFilter)) {
                    shouldShow = false;
                }
                
                if (searchTerm && shouldShow) {
                    const searchableText = (userName + ' ' + email).toLowerCase();
                    if (!searchableText.includes(searchTerm)) {
                        shouldShow = false;
                    }
                }
                
                card.style.display = shouldShow ? '' : 'none';
            });
            
            // Update results count
            document.getElementById('resultsCount').textContent = `Showing ${visibleCount} users`;
            
            // Show no results message
            toggleNoResultsMessage(visibleCount === 0);
        }

        function toggleNoResultsMessage(show) {
            let noResultsRow = document.getElementById('noResultsRow');
            const emptyRow = document.getElementById('emptyRow');
            
            if (emptyRow) {
                emptyRow.style.display = show ? '' : 'none';
            }
            
            if (show && !noResultsRow && !emptyRow) {
                const tbody = document.querySelector('#usersTable tbody');
                noResultsRow = document.createElement('tr');
                noResultsRow.id = 'noResultsRow';
                noResultsRow.innerHTML = `
                    <td colspan="6" class="text-center py-4">
                        <div class="empty-state">
                            <i class="fas fa-search fa-2x text-muted mb-2"></i>
                            <h6 class="text-muted">No users match your criteria</h6>
                            <p class="text-muted mb-0">Try adjusting your filters or search terms</p>
                        </div>
                    </td>
                `;
                tbody.appendChild(noResultsRow);
            } else if (!show && noResultsRow) {
                noResultsRow.remove();
            }
        }

        // View toggle functionality
        function toggleView(viewType) {
            const tableView = document.getElementById('tableView');
            const cardView = document.getElementById('cardView');
            const tableBtn = document.getElementById('tableViewBtn');
            const cardBtn = document.getElementById('cardViewBtn');
            
            if (viewType === 'table') {
                tableView.style.display = 'block';
                cardView.style.display = 'none';
                tableBtn.classList.add('btn-primary');
                tableBtn.classList.remove('btn-outline-secondary');
                cardBtn.classList.add('btn-outline-secondary');
                cardBtn.classList.remove('btn-primary');
            } else {
                tableView.style.display = 'none';
                cardView.style.display = 'flex';
                cardView.classList.add('row');
                cardBtn.classList.add('btn-primary');
                cardBtn.classList.remove('btn-outline-secondary');
                tableBtn.classList.add('btn-outline-secondary');
                tableBtn.classList.remove('btn-primary');
            }
            
            localStorage.setItem('usersViewPreference', viewType);
        }

        // Restore view preference
        document.addEventListener('DOMContentLoaded', function() {
            const savedView = localStorage.getItem('usersViewPreference') || 'table';
            toggleView(savedView);
        });

        // Export functionality
        function exportUsers() {
            const visibleRows = Array.from(document.querySelectorAll('#usersTable tbody tr.user-row'))
                .filter(row => row.style.display !== 'none');
            
            if (visibleRows.length === 0) {
                alert('No data to export');
                return;
            }
            
            // CSV Export
            let csv = 'Full Name,Email,Role,Last Login,Status\n';
            visibleRows.forEach(row => {
                const name = row.querySelector('.user-name')?.textContent.trim() || '';
                const email = row.querySelector('.email-info a')?.textContent.trim() || '';
                const role = row.querySelector('.role-badge')?.textContent.trim() || '';
                const lastLogin = row.cells[3]?.textContent.trim() || '';
                const status = row.querySelector('.status-badge')?.textContent.trim() || '';
                csv += `"${name}","${email}","${role}","${lastLogin}","${status}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'users_export_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
        }

        // Reset password function
        function resetPassword(userId, userName) {
            if (confirm(`Reset password for "${userName}"? The user will need to set a new password.`)) {
                // This would typically make an AJAX call to the server
                alert(`Password reset functionality will send reset instructions to ${userName}.`);
            }
        }

        // Sort functionality
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', function() {
                const columnIndex = parseInt(this.getAttribute('data-sort'));
                
                let sortDirection = 'asc';
                if (this.classList.contains('sort-asc')) {
                    sortDirection = 'desc';
                    this.classList.remove('sort-asc');
                    this.classList.add('sort-desc');
                } else {
                    sortDirection = 'asc';
                    this.classList.remove('sort-desc');
                    this.classList.add('sort-asc');
                }
                
                document.querySelectorAll('.sortable').forEach(h => {
                    if (h !== this) {
                        h.classList.remove('sort-asc', 'sort-desc');
                    }
                });
                
                sortTable(columnIndex, sortDirection);
            });
        });

        function sortTable(columnIndex, direction) {
            const tbody = document.querySelector('#usersTable tbody');
            const rows = Array.from(tbody.querySelectorAll('tr.user-row'));
            
            rows.sort((a, b) => {
                let aVal, bVal;
                
                if (columnIndex === 0) {
                    aVal = a.querySelector('.user-name')?.textContent.trim() || '';
                    bVal = b.querySelector('.user-name')?.textContent.trim() || '';
                } else if (columnIndex === 1) {
                    aVal = a.querySelector('.email-info a')?.textContent.trim() || '';
                    bVal = b.querySelector('.email-info a')?.textContent.trim() || '';
                } else if (columnIndex === 2) {
                    aVal = a.querySelector('.role-badge')?.textContent.trim() || '';
                    bVal = b.querySelector('.role-badge')?.textContent.trim() || '';
                } else {
                    aVal = a.cells[columnIndex]?.textContent.trim() || '';
                    bVal = b.cells[columnIndex]?.textContent.trim() || '';
                }
                
                const comparison = aVal.localeCompare(bVal);
                return direction === 'asc' ? comparison : -comparison;
            });
            
            rows.forEach(row => tbody.appendChild(row));
        }

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
}
