@model MVC_WEB.Models.ViewModels.StockBatchesViewModel
@{
    ViewData["Title"] = "Stock Batches";
    var isAdmin = Context.Session.GetString("role") == "Admin";
}

<!-- Page Header -->
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1><i class="fas fa-layer-group text-primary"></i> Stock Batches</h1>
            <p class="mb-0">Monitor and manage product batches, expiry dates, and batch-specific inventory</p>
        </div>
        <div class="d-flex gap-2">
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Stock
            </a>
            @if (isAdmin)
            {
                <a asp-action="AddBatch" class="btn btn-success">
                    <i class="fas fa-plus"></i> Add New Batch
                </a>
            }
            <button class="btn btn-outline-primary" onclick="exportBatches()">
                <i class="fas fa-download"></i> Export Report
            </button>
        </div>
    </div>
</div>

<!-- Batch Statistics -->
<div class="kpi-grid mb-4">
    <div class="kpi-card">
        <div class="kpi-header">
            <div class="kpi-title">Total Batches</div>
            <div class="kpi-icon" style="background: linear-gradient(45deg, #3498db, #5dade2);">
                <i class="fas fa-layer-group"></i>
            </div>
        </div>
        <div class="kpi-value">@Model.TotalBatches</div>
        <div class="kpi-change positive">
            <i class="fas fa-boxes"></i> Active batches
        </div>
    </div>

    <div class="kpi-card">
        <div class="kpi-header">
            <div class="kpi-title">Expiring Soon</div>
            <div class="kpi-icon" style="background: linear-gradient(45deg, #f39c12, #f7dc6f);">
                <i class="fas fa-clock"></i>
            </div>
        </div>
        <div class="kpi-value">@Model.ExpiringSoon</div>
        <div class="kpi-change negative">
            <i class="fas fa-exclamation-triangle"></i> Next 30 days
        </div>
    </div>

    <div class="kpi-card">
        <div class="kpi-header">
            <div class="kpi-title">Low Stock Batches</div>
            <div class="kpi-icon" style="background: linear-gradient(45deg, #e74c3c, #ec7063);">
                <i class="fas fa-exclamation-circle"></i>
            </div>
        </div>
        <div class="kpi-value">@Model.LowStockBatches</div>
        <div class="kpi-change negative">
            <i class="fas fa-arrow-down"></i> Need attention
        </div>
    </div>

    <div class="kpi-card">
        <div class="kpi-header">
            <div class="kpi-title">Total Units</div>
            <div class="kpi-icon" style="background: linear-gradient(45deg, #27ae60, #58d68d);">
                <i class="fas fa-warehouse"></i>
            </div>
        </div>
        <div class="kpi-value">@Model.TotalUnits</div>
        <div class="kpi-change positive">
            <i class="fas fa-chart-line"></i> All batches
        </div>
    </div>
</div>

<!-- Filters and Search -->
<div class="dashboard-card mb-4">
    <div class="row align-items-center">
        <div class="col-md-3">
            <h6 class="mb-2 text-muted">Batch Controls</h6>
            <div class="d-flex gap-2 flex-wrap">
                <a asp-action="Expiring" class="btn btn-sm btn-outline-warning">
                    <i class="fas fa-clock"></i> Expiring
                </a>
                <button class="btn btn-sm btn-outline-danger" onclick="filterLowStock()">
                    <i class="fas fa-exclamation-triangle"></i> Low Stock
                </button>
                <button class="btn btn-sm btn-success" onclick="location.reload()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
        <div class="col-md-9">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label small text-muted">Product Filter</label>
                    <select class="form-select form-select-sm" id="productFilter" onchange="filterByProduct()">
                        <option value="">All Products</option>
                        @foreach (var product in Model.Batches.Select(b => b.ProductName).Distinct().OrderBy(p => p))
                        {
                            <option value="@product">@product</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small text-muted">Expiry Status</label>
                    <select class="form-select form-select-sm" id="expiryFilter" onchange="filterByExpiry()">
                        <option value="">All Batches</option>
                        <option value="expired">Expired</option>
                        <option value="expiring">Expiring (30 days)</option>
                        <option value="fresh">Fresh (>30 days)</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small text-muted">Stock Status</label>
                    <select class="form-select form-select-sm" id="stockFilter" onchange="filterByStockLevel()">
                        <option value="">All Stock Levels</option>
                        <option value="empty">Out of Stock</option>
                        <option value="low">Low Stock (â‰¤10)</option>
                        <option value="normal">Normal Stock</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small text-muted">Search Batches</label>
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control search-input" id="searchInput" placeholder="Batch number, product...">
                        <button class="btn btn-outline-secondary" type="button" onclick="searchBatches()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Batches Table -->
<div class="table-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0"><i class="fas fa-list text-primary"></i> Batch Inventory</h5>
        <small class="text-muted">Showing @Model.Batches.Count() batches</small>
    </div>

    <div class="table-responsive">
        <table class="table table-hover" id="batchesTable">
            <thead class="table-light">
                <tr>
                    <th><i class="fas fa-barcode text-muted me-1"></i>Batch Number</th>
                    <th><i class="fas fa-pills text-muted me-1"></i>Product</th>
                    <th><i class="fas fa-industry text-muted me-1"></i>Supplier</th>
                    <th class="text-center"><i class="fas fa-warehouse text-muted me-1"></i>Quantity</th>
                    <th class="text-center"><i class="fas fa-calendar text-muted me-1"></i>Expiry Date</th>
                    <th class="text-center"><i class="fas fa-check-circle text-muted me-1"></i>Status</th>
                    <th class="text-center" style="width: 120px;"><i class="fas fa-cogs text-muted me-1"></i>Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Batches != null && Model.Batches.Any())
                {
                    @foreach (var batch in Model.Batches)
                    {
                        var daysUntilExpiry = (batch.ExpiryDate - DateTime.Now).TotalDays;
                        <tr class="batch-row" 
                            data-product="@batch.ProductName" 
                            data-expiry="@daysUntilExpiry" 
                            data-stock="@batch.QuantityInStock">
                            <td>
                                <code class="batch-number">@batch.BatchNumber</code>
                            </td>
                            <td>
                                <div class="product-info">
                                    <strong>@batch.ProductName</strong>
                                </div>
                            </td>
                            <td>
                                <span class="text-muted">@batch.SupplierName</span>
                            </td>
                            <td class="text-center">
                                @if (batch.QuantityInStock == 0)
                                {
                                    <span class="badge bg-danger">0 units</span>
                                }
                                else if (batch.QuantityInStock <= 10)
                                {
                                    <span class="badge bg-warning">@batch.QuantityInStock units</span>
                                }
                                else
                                {
                                    <span class="badge bg-success">@batch.QuantityInStock units</span>
                                }
                            </td>
                            <td class="text-center">
                                @if (batch.IsExpired)
                                {
                                    <span class="badge bg-danger">
                                        <i class="fas fa-times-circle me-1"></i>Expired
                                    </span>
                                }
                                else if (daysUntilExpiry <= 7)
                                {
                                    <span class="badge bg-danger">
                                        <i class="fas fa-exclamation-triangle me-1"></i>@batch.ExpiryDate.ToString("MMM dd, yyyy")
                                    </span>
                                }
                                else if (daysUntilExpiry <= 30)
                                {
                                    <span class="badge bg-warning">
                                        <i class="fas fa-clock me-1"></i>@batch.ExpiryDate.ToString("MMM dd, yyyy")
                                    </span>
                                }
                                else
                                {
                                    <span class="text-muted">@batch.ExpiryDate.ToString("MMM dd, yyyy")</span>
                                }
                            </td>
                            <td class="text-center">
                                @if (batch.IsExpired)
                                {
                                    <span class="badge bg-danger">Expired</span>
                                }
                                else if (batch.QuantityInStock == 0)
                                {
                                    <span class="badge bg-secondary">Empty</span>
                                }
                                else if (batch.IsExpiringSoon)
                                {
                                    <span class="badge bg-warning">Expiring</span>
                                }
                                else
                                {
                                    <span class="badge bg-success">Active</span>
                                }
                            </td>
                            <td>
                                <div class="action-buttons d-flex gap-1 justify-content-center">
                                    @if (isAdmin)
                                    {
                                        <a asp-action="Adjustments" asp-route-productId="@batch.ProductID" 
                                           class="btn btn-sm btn-outline-primary" title="Adjust Stock">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <form asp-action="DeleteBatch" asp-route-id="@batch.ProductBatchID" method="post" 
                                              class="d-inline" onsubmit="return confirm('Are you sure you want to delete this batch?');">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete Batch">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <div class="empty-state">
                                <i class="fas fa-layer-group fa-3x text-muted mb-3"></i>
                                <h6 class="text-muted">No batches found</h6>
                                <p class="text-muted mb-3">Add batches to track inventory by batch</p>
                                @if (isAdmin)
                                {
                                    <a asp-action="AddBatch" class="btn btn-success">
                                        <i class="fas fa-plus"></i> Add First Batch
                                    </a>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        function exportBatches() {
            const table = document.getElementById('batchesTable');
            const rows = table.querySelectorAll('tr');
            let csv = [];

            rows.forEach(row => {
                const cols = row.querySelectorAll('td, th');
                const rowData = [];
                cols.forEach((col, index) => {
                    if (index < 6) {
                        rowData.push('"' + col.innerText.replace(/"/g, '""') + '"');
                    }
                });
                csv.push(rowData.join(','));
            });

            const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'batches_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
        }

        function searchBatches() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#batchesTable tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            });
        }

        function filterByProduct() {
            const product = document.getElementById('productFilter').value;
            const rows = document.querySelectorAll('.batch-row');
            
            rows.forEach(row => {
                const rowProduct = row.dataset.product;
                row.style.display = !product || rowProduct === product ? '' : 'none';
            });
        }

        function filterByExpiry() {
            const filter = document.getElementById('expiryFilter').value;
            const rows = document.querySelectorAll('.batch-row');
            
            rows.forEach(row => {
                const daysUntilExpiry = parseFloat(row.dataset.expiry);
                let show = true;
                
                if (filter === 'expired') show = daysUntilExpiry < 0;
                else if (filter === 'expiring') show = daysUntilExpiry >= 0 && daysUntilExpiry <= 30;
                else if (filter === 'fresh') show = daysUntilExpiry > 30;
                
                row.style.display = show ? '' : 'none';
            });
        }

        function filterByStockLevel() {
            const filter = document.getElementById('stockFilter').value;
            const rows = document.querySelectorAll('.batch-row');
            
            rows.forEach(row => {
                const stock = parseInt(row.dataset.stock);
                let show = true;
                
                if (filter === 'empty') show = stock === 0;
                else if (filter === 'low') show = stock > 0 && stock <= 10;
                else if (filter === 'normal') show = stock > 10;
                
                row.style.display = show ? '' : 'none';
            });
        }

        function filterLowStock() {
            document.getElementById('stockFilter').value = 'low';
            filterByStockLevel();
        }

        document.getElementById('searchInput').addEventListener('keyup', function(e) {
            if (e.key === 'Enter') searchBatches();
        });
    </script>
}
