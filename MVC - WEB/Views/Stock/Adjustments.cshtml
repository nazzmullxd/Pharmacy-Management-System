@model MVC_WEB.Models.ViewModels.StockAdjustmentsViewModel
@{
    ViewData["Title"] = "Stock Adjustments";
}

<!-- Page Header -->
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1><i class="fas fa-edit text-primary"></i> Stock Adjustments</h1>
            <p class="mb-0">Make precise inventory adjustments to maintain accurate stock levels</p>
        </div>
        <div class="d-flex gap-2">
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Stock
            </a>
            <a asp-action="Batches" class="btn btn-outline-info">
                <i class="fas fa-layer-group"></i> View Batches
            </a>
            <button class="btn btn-outline-primary" onclick="exportAdjustments()">
                <i class="fas fa-download"></i> Export History
            </button>
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(Model.Message))
{
    <div class="alert @(Model.Message.Contains("success") ? "alert-success" : "alert-danger") alert-dismissible fade show" role="alert">
        <i class="fas @(Model.Message.Contains("success") ? "fa-check-circle" : "fa-exclamation-circle") me-2"></i>@Model.Message
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Adjustment Form Section -->
<div class="dashboard-card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="fas fa-plus-circle me-2"></i>Record Stock Adjustment
        </h5>
    </div>
    <div class="card-body">
        <form asp-action="Adjustments" method="post" id="adjustmentForm">
            <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
            
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">
                        <i class="fas fa-layer-group text-primary me-1"></i>Select Batch <span class="text-danger">*</span>
                    </label>
                    <select name="SelectedBatchId" class="form-select search-select" required id="batchSelect">
                        <option value="">-- Select Batch to Adjust --</option>
                        @foreach (var b in Model.Batches)
                        {
                            <option value="@b.ProductBatchID" 
                                    data-product="@b.ProductName" 
                                    data-stock="@b.QuantityInStock"
                                    data-batch="@b.BatchNumber">
                                @b.BatchNumber - @b.ProductName (@b.QuantityInStock units remaining)
                            </option>
                        }
                    </select>
                    <div class="form-text">
                        <i class="fas fa-info-circle text-info me-1"></i>
                        Choose the specific batch you want to adjust
                    </div>
                </div>

                <div class="col-md-3">
                    <label class="form-label">
                        <i class="fas fa-exchange-alt text-primary me-1"></i>Adjustment Type <span class="text-danger">*</span>
                    </label>
                    <select name="AdjustmentType" class="form-select" required id="adjustmentType">
                        <option value="">Select type...</option>
                        <option value="Increase">Increase Stock</option>
                        <option value="Decrease">Decrease Stock</option>
                        <option value="Correction" selected>Stock Correction</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">
                        <i class="fas fa-sort-numeric-up text-primary me-1"></i>Quantity <span class="text-danger">*</span>
                    </label>
                    <input name="AdjustedQuantity" type="number" class="form-control" 
                           min="1" step="1" required placeholder="Enter quantity" id="quantityInput">
                    <div class="form-text" id="stockPreview"></div>
                </div>

                <div class="col-md-12">
                    <label class="form-label">
                        <i class="fas fa-clipboard-list text-primary me-1"></i>Reason for Adjustment <span class="text-danger">*</span>
                    </label>
                    <input name="Reason" class="form-control" required 
                           placeholder="e.g., Expired products, Damaged items, Counting error, Found inventory">
                    <div class="form-text">
                        Provide a clear reason for this stock adjustment for audit purposes
                    </div>
                </div>
            </div>

            <!-- Batch Info Display -->
            <div id="batchInfo" style="display: none;" class="mt-3">
                <div class="alert alert-info">
                    <div class="row">
                        <div class="col-md-4">
                            <strong>Selected Batch:</strong>
                            <span id="selectedBatch" class="badge bg-primary ms-1"></span>
                        </div>
                        <div class="col-md-4">
                            <strong>Product:</strong>
                            <span id="selectedProduct" class="badge bg-info ms-1"></span>
                        </div>
                        <div class="col-md-4">
                            <strong>Current Stock:</strong>
                            <span id="currentBatchStock" class="badge bg-success ms-1">0 units</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex gap-2 mt-4">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-save me-2"></i>Apply Adjustment
                </button>
                <button type="reset" class="btn btn-outline-secondary" onclick="resetForm()">
                    <i class="fas fa-undo me-2"></i>Reset Form
                </button>
                <a asp-action="Batches" class="btn btn-outline-info">
                    <i class="fas fa-layer-group me-2"></i>View All Batches
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Recent Adjustments History -->
<div class="table-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">
            <i class="fas fa-history text-primary me-2"></i>Recent Adjustments
        </h5>
        <small class="text-muted">Last 20 adjustments</small>
    </div>

    <div class="table-responsive">
        <table class="table table-hover" id="adjustmentsTable">
            <thead class="table-light">
                <tr>
                    <th><i class="fas fa-calendar text-muted me-1"></i>Date</th>
                    <th><i class="fas fa-exchange-alt text-muted me-1"></i>Type</th>
                    <th class="text-center"><i class="fas fa-sort-numeric-up text-muted me-1"></i>Quantity</th>
                    <th><i class="fas fa-clipboard text-muted me-1"></i>Reason</th>
                    <th class="text-center"><i class="fas fa-check-circle text-muted me-1"></i>Status</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.RecentAdjustments != null && Model.RecentAdjustments.Any())
                {
                    @foreach (var adjustment in Model.RecentAdjustments)
                    {
                        <tr>
                            <td>
                                <span class="text-muted">@adjustment.AdjustmentDate.ToString("MMM dd, yyyy HH:mm")</span>
                            </td>
                            <td>
                                @if (adjustment.AdjustmentType.ToLower() == "increase")
                                {
                                    <span class="badge bg-success">
                                        <i class="fas fa-plus me-1"></i>Increase
                                    </span>
                                }
                                else if (adjustment.AdjustmentType.ToLower() == "decrease")
                                {
                                    <span class="badge bg-danger">
                                        <i class="fas fa-minus me-1"></i>Decrease
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-info">
                                        <i class="fas fa-edit me-1"></i>Correction
                                    </span>
                                }
                            </td>
                            <td class="text-center">
                                <strong>@adjustment.AdjustedQuantity</strong> units
                            </td>
                            <td>
                                <span title="@adjustment.Reason">
                                    @(adjustment.Reason.Length > 50 ? adjustment.Reason.Substring(0, 50) + "..." : adjustment.Reason)
                                </span>
                            </td>
                            <td class="text-center">
                                @if (adjustment.IsApproved)
                                {
                                    <span class="badge bg-success">
                                        <i class="fas fa-check me-1"></i>Approved
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-warning">
                                        <i class="fas fa-clock me-1"></i>Pending
                                    </span>
                                }
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="5" class="text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-history fa-2x mb-2"></i>
                                <p class="mb-0">No recent adjustments</p>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.getElementById('batchSelect').addEventListener('change', function() {
            const selected = this.options[this.selectedIndex];
            const batchInfo = document.getElementById('batchInfo');
            
            if (this.value) {
                document.getElementById('selectedBatch').textContent = selected.dataset.batch;
                document.getElementById('selectedProduct').textContent = selected.dataset.product;
                document.getElementById('currentBatchStock').textContent = selected.dataset.stock + ' units';
                batchInfo.style.display = 'block';
            } else {
                batchInfo.style.display = 'none';
            }
            updateStockPreview();
        });

        document.getElementById('adjustmentType').addEventListener('change', updateStockPreview);
        document.getElementById('quantityInput').addEventListener('input', updateStockPreview);

        function updateStockPreview() {
            const batchSelect = document.getElementById('batchSelect');
            const selected = batchSelect.options[batchSelect.selectedIndex];
            const currentStock = parseInt(selected.dataset.stock || 0);
            const adjustmentType = document.getElementById('adjustmentType').value;
            const quantity = parseInt(document.getElementById('quantityInput').value || 0);
            const preview = document.getElementById('stockPreview');

            if (batchSelect.value && quantity > 0) {
                let newStock = currentStock;
                if (adjustmentType === 'Increase') {
                    newStock = currentStock + quantity;
                } else if (adjustmentType === 'Decrease') {
                    newStock = currentStock - quantity;
                } else if (adjustmentType === 'Correction') {
                    newStock = quantity;
                }
                
                const change = newStock - currentStock;
                const changeClass = change > 0 ? 'text-success' : change < 0 ? 'text-danger' : 'text-muted';
                const changeSign = change > 0 ? '+' : '';
                
                preview.innerHTML = `New stock: <strong>${newStock}</strong> (<span class="${changeClass}">${changeSign}${change}</span>)`;
            } else {
                preview.innerHTML = '';
            }
        }

        function resetForm() {
            document.getElementById('batchInfo').style.display = 'none';
            document.getElementById('stockPreview').innerHTML = '';
        }

        function exportAdjustments() {
            const table = document.getElementById('adjustmentsTable');
            const rows = table.querySelectorAll('tr');
            let csv = [];

            rows.forEach(row => {
                const cols = row.querySelectorAll('td, th');
                const rowData = [];
                cols.forEach(col => {
                    rowData.push('"' + col.innerText.replace(/"/g, '""') + '"');
                });
                csv.push(rowData.join(','));
            });

            const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'stock_adjustments_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
        }
    </script>
}
